
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ ¡åœ’æ•¸ä½å…±å‰µæ°´æ—ç®± (å®Œç¾æµç¨‹ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #222; font-family: "Microsoft JhengHei", sans-serif; }
        
        #aquarium {
            width: 100%; height: 100%; position: relative; overflow: hidden;
            background: linear-gradient(180deg,#4facfe 0%, #00f2fe 100%);
            background-size: cover; background-position: center; transition: background 0.5s ease;
        }
        #bg-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; z-index: 0; pointer-events: none; }
        #sand { position: absolute; bottom: 0; width: 100%; height: 80px; background: #e6d99c; border-top: 5px solid #d4c585; z-index: 2; pointer-events: none; transition: opacity 0.5s; }

        /* --- UI å…ƒä»¶ --- */
        #class-list-bar { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background: rgba(0,0,0,0.5); z-index: 140; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; white-space: nowrap; gap: 8px; }
        #class-list-bar::-webkit-scrollbar { display: none; }
        .lobby-btn { background: linear-gradient(45deg, #FFD700, #FFA500); color: #333; font-weight: bold; padding: 6px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 10px rgba(255,215,0,0.5); display: flex; align-items: center; gap: 5px; }
        .class-tag { background: rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); transition: 0.2s; }
        .class-tag.active { background: #007bff; border-color: #007bff; box-shadow: 0 0 10px #007bff; }

        #top-nav { position: absolute; top: 60px; left: 15px; z-index: 150; display: flex; flex-direction: column; gap: 10px; align-items: flex-start; }
        #class-input-area, #class-management-area { background: rgba(0,0,0,0.7); padding: 8px; border-radius: 8px; display: flex; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #class-management-area { display: none; align-items: center; }
        #class-label-btn { background: rgba(0,123,255,0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; }
        input.class-input { padding: 5px; border-radius: 4px; border: none; width: 90px; text-align: center; outline: none; }
        #menu-toggle-btn { background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }

        #controls-container { margin-top: 5px; display: flex; flex-direction: column; gap: 10px; transform-origin: top left; transition: transform 0.3s, opacity 0.3s; }
        .controls-hidden { transform: scale(0); opacity: 0; pointer-events: none; height: 0; }
        .panel { background: rgba(255,255,255,0.95); padding: 12px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 8px; width: 180px; }
        h3 { margin: 0 0 5px 0; font-size: 16px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        
        .btn { border: none; padding: 8px; border-radius: 6px; font-size: 14px; cursor: pointer; color: white; text-align: center; font-weight: bold; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: #007bff; } .btn-orange { background: #fd7e14; } .btn-red { background: #dc3545; }
        .btn-gray { background: #6c757d; } .btn-purple { background: #6f42c1; } .btn-gold { background: #ffc107; color: #333; } .btn-green { background: #28a745; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .delete-mode-active { background: #dc3545 !important; animation: pulse-red 1s infinite; }
        .submit-mode-active { background: #ffc107 !important; color:black; animation: pulse-gold 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }

        input[type="file"] { display: none; }
        .fish-container { position: absolute; z-index: 10; display: flex; flex-direction: column; align-items: center; pointer-events: auto; transition: opacity 0.5s; }
        .fish-img { filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); transition: filter 0.2s; }
        .fish-name-label { color: white; font-size: 13px; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.9); margin-bottom: 4px; white-space: nowrap; padding: 2px 6px; background: rgba(0,0,0,0.3); border-radius: 10px; }
        .fish-container.deletable .fish-img:hover { filter: drop-shadow(0 0 10px red); transform: scale(1.1); }
        .fish-container.submittable .fish-img:hover { filter: drop-shadow(0 0 15px gold); transform: scale(1.2); }
        .fish-container.has-author { cursor: help; }

        /* --- æ¨¡æ…‹è¦–çª—èˆ‡å…©éšæ®µä½ˆå±€ --- */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; }
        
        /* éšæ®µ 1: è£å‰ª */
        #step1-crop { flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; }
        #canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; touch-action: none; background: #111; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #crop-toolbar { height: 70px; background: #333; display: flex; align-items: center; justify-content: center; gap: 15px; padding: 10px; color: white; border-top: 1px solid #555; }

        /* éšæ®µ 2: é è¦½ */
        #step2-preview { display: none; flex: 1; flex-direction: column; width: 100%; height: 100%; }
        #preview-viewport { flex: 1; width: 100%; background-color: #222; background-size: cover; background-position: center; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #preview-fish-final { max-width: none; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); transition: width 0.1s; }
        #preview-toolbar { height: 100px; background: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; color: white; border-top: 1px solid #555; }

        .radio-group { display: flex; gap: 10px; background: #555; padding: 5px 15px; border-radius: 20px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 14px; color: white;}
        input[type=range] { width: 250px; accent-color: #007bff; }

        /* å°è©±æ¡† */
        #custom-dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); z-index: 9999; display: none; align-items: center; justify-content: center; }
        #custom-dialog-box { background: rgba(30,30,30,0.85); color: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; animation: popIn 0.3s ease; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        #dialog-title { font-size: 18px; margin: 0 0 10px 0; font-weight: bold; color: #ffeb3b; }
        #dialog-msg { font-size: 15px; margin-bottom: 20px; line-height: 1.5; color: #eee; }
        #dialog-input { width: 90%; padding: 10px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #555; background: rgba(255,255,255,0.1); color: white; font-size: 16px; text-align: center; outline: none; display: none; }
        #dialog-buttons { display: flex; gap: 10px; justify-content: center; }
        .dialog-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; }
        #btn-confirm { background: #007bff; color: white; } #btn-cancel { background: #555; color: white; }

        #loading-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 5; pointer-events: none; }
    </style>
</head>
<body>

    <div id="aquarium">
        <div id="class-list-bar">
            <div class="lobby-btn" onclick="initClassRoom('Lobby')">ğŸ  å¤§å»³ (å„ªç§€ä½œå“)</div>
            <span style="color:rgba(255,255,255,0.3); font-size:18px;">|</span>
            <div id="dynamic-class-list" style="display:flex; gap:8px;"></div>
        </div>

        <div id="top-nav">
            <div id="class-input-area">
                <input type="text" id="classInput" class="class-input" placeholder="è¼¸å…¥ç­è™Ÿ">
                <button class="btn btn-blue" style="padding: 5px 10px;" onclick="switchClass()">é€²å…¥/æ–°å¢</button>
            </div>
            <div id="class-management-area">
                <div id="class-label-btn" onclick="showClassInput()" title="é»æ“Šåˆ‡æ›å…¶ä»–ç­ç´š">
                    <span id="current-class-text">ğŸ“ 501 ç­</span>
                </div>
                <button class="btn btn-orange btn-sm" onclick="renameCurrentClass()" title="ä¿®æ”¹ç­ç´šåç¨±">âœï¸</button>
                <button class="btn btn-red btn-sm" onclick="deleteCurrentClass()" title="åˆªé™¤æ•´å€‹ç­ç´š">âŒ</button>
            </div>
            <button id="menu-toggle-btn" onclick="toggleControls()" title="é¡¯ç¤º/éš±è—é¸å–®">â˜°</button>

            <div id="controls-container">
                <div class="panel">
                    <h3>ğŸŸ å‰µä½œèˆ‡ä¸Šå‚³</h3>
                    <button class="btn btn-blue" onclick="document.getElementById('fishInput').click()">ğŸ“¸ ä¸Šå‚³ä¸¦è£å‰ªç•«ä½œ</button>
                    <input type="file" id="fishInput" accept="image/*" onchange="handleFishFile(this)">
                </div>
                <div class="panel">
                    <h3>ğŸ› ï¸ ç®¡ç†å·¥å…·</h3>
                    <button id="submitModeBtn" class="btn btn-gold" onclick="toggleSubmitMode()">ğŸ† æŠ•ç¨¿å„ªç§€ä½œå“ (é—œ)</button>
                    <button id="deleteModeBtn" class="btn btn-purple" onclick="toggleDeleteMode()">âŒ åˆªé™¤å–®éš»é­š (é—œ)</button>
                    <button class="btn btn-red" onclick="clearAllFish()">ğŸ—‘ï¸ æ¸…ç©ºé­šç¼¸(ä¿ç•™ç­ç´š)</button>
                </div>
                <div class="panel">
                    <h3>ğŸ« å ´æ™¯è¨­å®š</h3>
                    <button class="btn btn-orange" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸ ä¸Šå‚³èƒŒæ™¯(å›ºå®šæ¡†)</button>
                    <input type="file" id="bgInput" accept="image/*" onchange="handleBgFile(this)">
                    <button class="btn btn-gray" onclick="resetBackground()">ğŸŒŠ æ¢å¾©æ·±æµ·</button>
                </div>
            </div>
        </div>

        <div id="loading-msg">æ­£åœ¨é€£ç·šè‡³é›²ç«¯æ°´æ—ç®±...</div>
        <img id="bg-image-layer" src="" alt="Background">
        <div id="sand"></div>
    </div>

    <div id="custom-dialog-overlay">
        <div id="custom-dialog-box">
            <div id="dialog-title">æç¤º</div>
            <div id="dialog-msg">è¨Šæ¯å…§å®¹</div>
            <input type="text" id="dialog-input">
            <div id="dialog-buttons">
                <button class="dialog-btn" id="btn-cancel">å–æ¶ˆ</button>
                <button class="dialog-btn" id="btn-confirm">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="modal">
        <div id="step1-crop">
            <div id="canvas-wrapper">
                <canvas id="editor"></canvas>
                <div style="position:absolute; bottom:10px; color:rgba(255,255,255,0.7); font-size:14px; text-shadow:0 1px 2px black;" id="instruction"></div>
            </div>
            <div id="crop-toolbar">
                <div class="radio-group" id="crop-mode-selector">
                    <label><input type="radio" name="mode" value="rect" checked onclick="setMode('rect')"> ğŸŸ¦ æ–¹å½¢</label>
                    <label><input type="radio" name="mode" value="poly" onclick="setMode('poly')"> âœ‚ï¸ æé‚Š</label>
                </div>
                <button class="btn btn-blue" id="nextStepBtn" onclick="goToStep2()">ä¸‹ä¸€æ­¥ï¼šèª¿æ•´å¤§å° â¡</button>
                <button class="btn btn-green" id="directBgUploadBtn" style="display:none;" onclick="finishUploadBg()">ç¢ºå®šæ›´æ›èƒŒæ™¯</button>
                <button class="btn btn-gray" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="step2-preview">
            <div id="preview-viewport">
                <img id="preview-fish-final" src="">
                <div style="position:absolute; top:15px; left:15px; color:rgba(255,255,255,0.8); font-size:14px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:20px;">
                    ğŸ‘ï¸ çœŸå¯¦ç’°å¢ƒæ¨¡æ“¬
                </div>
            </div>
            <div id="preview-toolbar">
                <div style="display:flex; align-items:center; gap:10px; width:90%; justify-content:center;">
                    <span style="font-size:14px;">èª¿æ•´å¤§å°:</span>
                    <span style="font-size:12px;">å°</span>
                    <input type="range" id="sizeSlider" min="30" max="300" value="100" oninput="updateFinalPreview(this.value)">
                    <span style="font-size:12px;">å¤§</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-gray" onclick="backToStep1()">â¬… ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-green" id="finishUploadBtn" onclick="finalUploadFish()">âœ… ç¢ºå®šæ”¾å…¥æ°´æ—ç®±</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAUoYIt2CdivHIoLK-ZjsucejJkuzzQRnA",
            authDomain: "fish321-36ce2.firebaseapp.com",
            databaseURL: "https://fish321-36ce2-default-rtdb.firebaseio.com",
            projectId: "fish321-36ce2",
            storageBucket: "fish321-36ce2.firebasestorage.app",
            messagingSenderId: "237771099270",
            appId: "1:237771099270:web:9621037d8ec40242091507",
            measurementId: "G-4QESL7JL49"
        };

        let dbRef = null; let rootRef = null; let bgRef = null; let currentClassId = "Lobby"; 
        let isDeleteMode = false; let isSubmitMode = false; let isControlsVisible = true;
        let currentUploadType = 'fish'; 
        let currentBgUrl = "";
        let tempCroppedFishData = null; // æš«å­˜æ­¥é©Ÿ1çš„çµæœ

        // --- Dialog System ---
        function showDialog(title, msg, type = 'alert', placeholder = '') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('custom-dialog-overlay');
                const titleEl = document.getElementById('dialog-title');
                const msgEl = document.getElementById('dialog-msg');
                const inputEl = document.getElementById('dialog-input');
                const btnConfirm = document.getElementById('btn-confirm');
                const btnCancel = document.getElementById('btn-cancel');

                titleEl.innerText = title; msgEl.innerText = msg; inputEl.value = '';
                inputEl.style.display = 'none'; btnCancel.style.display = 'none';
                if (type === 'prompt') { inputEl.style.display = 'block'; inputEl.value = placeholder; btnCancel.style.display = 'block'; }
                else if (type === 'confirm') { btnCancel.style.display = 'block'; }

                overlay.style.display = 'flex'; if(type === 'prompt') inputEl.focus();
                const close = () => { overlay.style.display = 'none'; btnConfirm.onclick = null; btnCancel.onclick = null; };
                btnConfirm.onclick = () => { close(); if (type === 'prompt') resolve(inputEl.value); else resolve(true); };
                btnCancel.onclick = () => { close(); resolve(false); };
            });
        }
        async function customAlert(msg) { await showDialog("æç¤º", msg, 'alert'); }
        async function customConfirm(msg) { return await showDialog("ç¢ºèª", msg, 'confirm'); }
        async function customPrompt(msg, placeholder = "") { const res = await showDialog("è¼¸å…¥", msg, 'prompt', placeholder); return res === false ? null : res; }

        // --- Main Logic ---
        try {
            firebase.initializeApp(firebaseConfig);
            rootRef = firebase.database().ref('school_aquarium_fish');
            listenToClassList();
            initClassRoom("Lobby");
        } catch (e) { console.error(e); }

        function listenToClassList() {
            rootRef.on('value', (snapshot) => {
                const listContainer = document.getElementById('dynamic-class-list');
                listContainer.innerHTML = ""; 
                snapshot.forEach((childSnapshot) => {
                    const className = childSnapshot.key;
                    if (className !== "Lobby") {
                        const tag = document.createElement('div'); tag.className = 'class-tag';
                        if(className === currentClassId) tag.classList.add('active');
                        tag.innerText = className;
                        tag.onclick = () => { document.getElementById('classInput').value = className; switchClass(); };
                        listContainer.appendChild(tag);
                    }
                });
            });
        }

        async function switchClass() {
            let inputVal = document.getElementById('classInput').value.trim();
            if(!inputVal) { await customAlert("è«‹è¼¸å…¥ç­ç´šåç¨±ï¼"); return; }
            if(inputVal === "Lobby") return initClassRoom("Lobby");
            const safeClassId = inputVal.replace(/[.#$/[\]]/g, "_");
            initClassRoom(safeClassId);
            document.getElementById('class-input-area').style.display = 'none';
            document.getElementById('class-management-area').style.display = 'flex';
            document.getElementById('current-class-text').innerText = `ğŸ“ ${safeClassId} ç­`;
            document.getElementById('classInput').value = '';
            updateClassHighlight(safeClassId);
        }
        function showClassInput() { document.getElementById('class-management-area').style.display = 'none'; document.getElementById('class-input-area').style.display = 'flex'; }
        function updateClassHighlight(className) { document.querySelectorAll('.class-tag').forEach(t => t.classList.remove('active')); Array.from(document.querySelectorAll('.class-tag')).forEach(t => { if(t.innerText === className) t.classList.add('active'); }); }

        async function deleteCurrentClass() {
            if(currentClassId === "Lobby") { await customAlert("å¤§å»³ä¸èƒ½åˆªé™¤ï¼"); return; }
            if(await customConfirm(`âš ï¸ è­¦å‘Šï¼\n\næ‚¨å³å°‡åˆªé™¤ã€${currentClassId}ã€‘æ•´å€‹ç­ç´šã€‚\nç¢ºå®šå—ï¼Ÿ`)) {
                firebase.database().ref('school_aquarium_fish/' + currentClassId).remove();
                firebase.database().ref('school_aquarium_bg/' + currentClassId).remove()
                .then(async () => { await customAlert("ç­ç´šå·²åˆªé™¤ï¼Œè¿”å›å¤§å»³ã€‚"); initClassRoom("Lobby"); showClassInput(); });
            }
        }
        async function renameCurrentClass() {
            if(currentClassId === "Lobby") { await customAlert("å¤§å»³ä¸èƒ½æ”¹åï¼"); return; }
            let newName = await customPrompt(`è«‹è¼¸å…¥ã€${currentClassId}ã€‘çš„æ–°åç¨±ï¼š`, currentClassId);
            if(newName && newName !== currentClassId) {
                let safeNewName = newName.replace(/[.#$/[\]]/g, "_");
                dbRef.once('value').then(snapshot => {
                    let data = snapshot.val();
                    firebase.database().ref('school_aquarium_fish/' + safeNewName).set(data).then(() => { dbRef.remove(); });
                });
                firebase.database().ref('school_aquarium_bg/' + currentClassId).once('value').then(snap => {
                    let bgData = snap.val();
                    if(bgData) {
                        firebase.database().ref('school_aquarium_bg/' + safeNewName).set(bgData)
                        .then(() => firebase.database().ref('school_aquarium_bg/' + currentClassId).remove());
                    }
                });
                await customAlert(`æ”¹åæˆåŠŸï¼è«‹é‡æ–°é€²å…¥ ${safeNewName}`); initClassRoom("Lobby"); showClassInput();
            }
        }

        function initClassRoom(classId) {
            if (dbRef) dbRef.off(); if (bgRef) bgRef.off();
            const allFishes = document.querySelectorAll('.fish-container');
            allFishes.forEach(f => f.remove()); fishes.length = 0;
            currentClassId = classId;
            if(classId === "Lobby") {
                document.getElementById('class-input-area').style.display = 'flex';
                document.getElementById('class-management-area').style.display = 'none';
                document.getElementById('classInput').value = "";
                updateClassHighlight("Lobby");
            }
            document.getElementById('loading-msg').style.display = 'block';
            document.getElementById('loading-msg').innerText = classId === "Lobby" ? "æ­£åœ¨é€²å…¥å„ªç§€ä½œå“å¤§å»³..." : `æ­£åœ¨è¼‰å…¥ ${classId} çš„æ°´æ—ç®±...`;

            dbRef = firebase.database().ref('school_aquarium_fish/' + classId);
            dbRef.on('child_added', (snapshot) => {
                const data = snapshot.val(); if(data && data.image) createFish(data, snapshot.key);
                document.getElementById('loading-msg').style.display = 'none';
            });
            dbRef.on('child_removed', (snapshot) => removeFishFromScreen(snapshot.key));

            bgRef = firebase.database().ref('school_aquarium_bg/' + classId);
            bgRef.on('value', (snapshot) => {
                const bgData = snapshot.val();
                const bgLayer = document.getElementById('bg-image-layer');
                const sandLayer = document.getElementById('sand');
                let defaultBg = "linear-gradient(180deg,#4facfe 0%, #00f2fe 100%)";
                if (bgData && bgData.image) {
                    bgLayer.src = bgData.image; bgLayer.style.opacity = 1; sandLayer.style.opacity = 0;
                    currentBgUrl = `url(${bgData.image})`;
                } else {
                    bgLayer.style.opacity = 0; sandLayer.style.opacity = 1;
                    currentBgUrl = defaultBg;
                }
            });
            resetModes();
        }

        function resetModes() { isDeleteMode = false; isSubmitMode = false; updateModeButtons(); document.getElementById('aquarium').style.cursor = "default"; }
        async function clearAllFish() {
            if(!dbRef) return; if(currentClassId === "Lobby") { await customAlert("å¤§å»³ä¸èƒ½ä¸€éµæ¸…ç©ºï¼"); return; }
            if(await customConfirm(`âš ï¸ ç¢ºå®šè¦æ¸…ç©ºé­šå—ï¼Ÿ(èƒŒæ™¯æœƒä¿ç•™)`)) dbRef.remove();
        }
        async function resetBackground() { if(await customConfirm("ç¢ºå®šè¦æ¢å¾©é è¨­æ·±æµ·èƒŒæ™¯å—ï¼Ÿ")) firebase.database().ref('school_aquarium_bg/' + currentClassId).remove(); }
        function toggleDeleteMode() { if(isSubmitMode) toggleSubmitMode(); isDeleteMode = !isDeleteMode; updateModeButtons(); }
        async function toggleSubmitMode() { 
            if(currentClassId === "Lobby") { await customAlert("è«‹åˆ°å„ç­ç´šæŠ•ç¨¿ï¼"); return; }
            if(isDeleteMode) toggleDeleteMode(); isSubmitMode = !isSubmitMode; updateModeButtons();
            if(isSubmitMode) await customAlert("âœ¨ é€²å…¥æŠ•ç¨¿æ¨¡å¼ï¼\n\né»æ“Šé­šå³å¯è¼¸å…¥ä½œè€…å§“åä¸¦æŠ•ç¨¿ã€‚");
        }
        function updateModeButtons() {
            const delBtn = document.getElementById('deleteModeBtn'); const subBtn = document.getElementById('submitModeBtn'); const aqua = document.getElementById('aquarium');
            if(isDeleteMode) { delBtn.innerText = "âœ… çµæŸåˆªé™¤"; delBtn.classList.add('delete-mode-active'); aqua.style.cursor = "crosshair"; } 
            else { delBtn.innerText = "âŒ åˆªé™¤å–®éš»é­š (é—œ)"; delBtn.classList.remove('delete-mode-active'); }
            if(isSubmitMode) { subBtn.innerText = "âœ¨ çµæŸæŠ•ç¨¿"; subBtn.classList.add('submit-mode-active'); aqua.style.cursor = "pointer"; }
            else { subBtn.innerText = "ğŸ† æŠ•ç¨¿å„ªç§€ä½œå“ (é—œ)"; subBtn.classList.remove('submit-mode-active'); }
            if(!isDeleteMode && !isSubmitMode) aqua.style.cursor = "default";
            fishes.forEach(fish => fish.updateStyle());
        }

        let canvas = document.getElementById('editor'); let ctx = canvas.getContext('2d'); let rawImg = new Image();
        let mode = 'rect'; let isDragging = false; let startPos = {x:0, y:0}; let rectData = {x:0, y:0, w:0, h:0}; let polyPoints = [];

        function toggleControls() {
            const container = document.getElementById('controls-container'); container.classList.toggle('controls-hidden');
        }
        function handleFishFile(input) {
            if (input.files && input.files[0]) {
                currentUploadType = 'fish'; let reader = new FileReader();
                reader.onload = function(e) { rawImg.onload = function() { openModal(); }; rawImg.src = e.target.result; };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        function handleBgFile(input) {
            if (input.files && input.files[0]) {
                currentUploadType = 'bg'; let reader = new FileReader();
                reader.onload = function(e) { rawImg.onload = function() { openModal(); }; rawImg.src = e.target.result; };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        // --- å…©éšæ®µ UI é‚è¼¯ ---
        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            resetCrop(); resizeCanvas();
            
            // é è¨­é¡¯ç¤º Step 1
            document.getElementById('step1-crop').style.display = 'flex';
            document.getElementById('step2-preview').style.display = 'none';

            if (currentUploadType === 'fish') {
                document.getElementById('crop-mode-selector').style.display = 'flex';
                document.getElementById('nextStepBtn').style.display = 'inline-block';
                document.getElementById('directBgUploadBtn').style.display = 'none';
                document.getElementById('instruction').innerText = "æ‹–æ›³ç•«å‡ºæ–¹æ¡† æˆ– ä½¿ç”¨æé‚Šå·¥å…·";
            } else {
                setMode('rect'); // èƒŒæ™¯å¼·åˆ¶æ–¹å½¢
                document.getElementById('crop-mode-selector').style.display = 'none';
                document.getElementById('nextStepBtn').style.display = 'none';
                document.getElementById('directBgUploadBtn').style.display = 'inline-block';
                document.getElementById('instruction').innerText = "èª¿æ•´æ¡†æ¡†ç¯„åœ (è‡ªå‹•ç¬¦åˆè¢å¹•æ¯”ä¾‹)";
            }
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // --- Step 1 -> Step 2 (ç”¢ç”Ÿè£å‰ªåœ– & é€²å…¥é è¦½) ---
        async function goToStep2() {
            if(mode==='rect' && rectData.w===0) { await customAlert("è«‹å…ˆæ¡†é¸ç¯„åœï¼"); return; }
            if(mode==='poly' && polyPoints.length<3) { await customAlert("è«‹è‡³å°‘é»3å€‹é»ï¼"); return; }

            // 1. ç”¢ç”Ÿè£å‰ªå¾Œçš„é­š (Base64)
            tempCroppedFishData = generateCroppedImage(false); 

            // 2. åˆ‡æ›ä»‹é¢
            document.getElementById('step1-crop').style.display = 'none';
            document.getElementById('step2-preview').style.display = 'flex';

            // 3. è¨­å®šé è¦½åœ–èˆ‡èƒŒæ™¯
            const previewViewport = document.getElementById('preview-viewport');
            previewViewport.style.background = currentBgUrl;
            previewViewport.style.backgroundSize = "cover";
            
            const previewImg = document.getElementById('preview-fish-final');
            previewImg.src = tempCroppedFishData;
            
            // 4. é‡ç½®æ»‘æ¡¿
            document.getElementById('sizeSlider').value = 100;
            updateFinalPreview(100);
        }

        function backToStep1() {
            document.getElementById('step2-preview').style.display = 'none';
            document.getElementById('step1-crop').style.display = 'flex';
        }

        function updateFinalPreview(val) {
            document.getElementById('preview-fish-final').style.width = val + 'px';
        }

        // --- æ ¸å¿ƒè£å‰ªé‚è¼¯ (å…±ç”¨) ---
        function generateCroppedImage(isBg) {
            let tempCanvas = document.createElement('canvas'); let tCtx = tempCanvas.getContext('2d'); let r = rawImg.width / canvas.width;
            let cropX, cropY, cropW, cropH;
            if(mode==='rect'){
                cropX = rectData.w > 0 ? rectData.x : rectData.x + rectData.w; cropY = rectData.h > 0 ? rectData.y : rectData.y + rectData.h;
                cropW = Math.abs(rectData.w); cropH = Math.abs(rectData.h);
            } else {
                let minX=Infinity, minY=Infinity, maxX=0, maxY=0; 
                polyPoints.forEach(p=>{if(p.x<minX)minX=p.x;if(p.x>maxX)maxX=p.x;if(p.y<minY)minY=p.y;if(p.y>maxY)maxY=p.y;});
                cropX = minX; cropY = minY; cropW = maxX - minX; cropH = maxY - minY;
            }
            const MAX_WIDTH = isBg ? 1024 : 500;
            let finalScale = 1; let realW = cropW * r; let realH = cropH * r;
            if (realW > MAX_WIDTH) finalScale = MAX_WIDTH / realW;
            tempCanvas.width = realW * finalScale; tempCanvas.height = realH * finalScale; tCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            if (mode === 'rect') { tCtx.drawImage(rawImg, cropX * r, cropY * r, realW, realH, 0, 0, tempCanvas.width, tempCanvas.height); } 
            else {
                tCtx.save(); tCtx.beginPath(); let scaleTotal = r * finalScale;
                tCtx.moveTo((polyPoints[0].x - cropX) * scaleTotal, (polyPoints[0].y - cropY) * scaleTotal);
                for(let i=1; i<polyPoints.length; i++) tCtx.lineTo((polyPoints[i].x - cropX) * scaleTotal, (polyPoints[i].y - cropY) * scaleTotal);
                tCtx.closePath(); tCtx.clip(); tCtx.drawImage(rawImg, -cropX * scaleTotal, -cropY * scaleTotal, rawImg.width * finalScale, rawImg.height * finalScale); tCtx.restore();
            }
            // é­šç”¨PNG(é€æ˜), èƒŒæ™¯ç”¨JPG
            return tempCanvas.toDataURL(isBg ? 'image/jpeg' : 'image/png', isBg ? 0.8 : 1.0);
        }

        // --- æœ€çµ‚ä¸Šå‚³ (Step 2 Confirm) ---
        function finalUploadFish() {
            if(!dbRef) return;
            let sizeVal = parseInt(document.getElementById('sizeSlider').value);
            document.getElementById('finishUploadBtn').innerText = "ä¸Šå‚³ä¸­...";
            dbRef.push({ image: tempCroppedFishData, size: sizeVal, timestamp: Date.now() })
            .then(() => { closeModal(); document.getElementById('finishUploadBtn').innerText = "âœ… ç¢ºå®šæ”¾å…¥æ°´æ—ç®±"; })
            .catch(async err => { await customAlert("ä¸Šå‚³å¤±æ•—"); document.getElementById('finishUploadBtn').innerText = "âœ… ç¢ºå®šæ”¾å…¥æ°´æ—ç®±"; });
        }

        // --- èƒŒæ™¯ç›´æ¥ä¸Šå‚³ (Step 1 Confirm) ---
        async function finishUploadBg() {
             if(rectData.w===0) { await customAlert("è«‹å…ˆèª¿æ•´æ¡†æ¡†ï¼"); return; }
             let bgBase64 = generateCroppedImage(true);
             if(currentClassId) {
                document.getElementById('directBgUploadBtn').innerText = "æ›´æ›ä¸­...";
                firebase.database().ref('school_aquarium_bg/' + currentClassId).set({ image: bgBase64, timestamp: Date.now() })
                .then(async () => { closeModal(); document.getElementById('directBgUploadBtn').innerText = "ç¢ºå®šæ›´æ›èƒŒæ™¯"; await customAlert("èƒŒæ™¯æ›´æ›æˆåŠŸï¼"); })
                .catch(async err => { await customAlert("ä¸Šå‚³å¤±æ•—"); document.getElementById('directBgUploadBtn').innerText = "ç¢ºå®šæ›´æ›èƒŒæ™¯"; });
             }
        }

        // --- Canvas ç¹ªåœ–èˆ‡äº’å‹• ---
        function resizeCanvas() {
            let wrapper = document.getElementById('canvas-wrapper');
            let scale = Math.min((wrapper.clientWidth-20)/rawImg.width, (wrapper.clientHeight-20)/rawImg.height);
            canvas.width = rawImg.width * scale; canvas.height = rawImg.height * scale; draw();
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (mode === 'rect') {
                if (currentUploadType === 'bg' && rectData.w === 0) initBgCropBox();
                if (rectData.w !== 0) {
                    ctx.clearRect(rectData.x, rectData.y, rectData.w, rectData.h);
                    ctx.drawImage(rawImg, rectData.x/(canvas.width/rawImg.width), rectData.y/(canvas.height/rawImg.height), rectData.w/(canvas.width/rawImg.width), rectData.h/(canvas.height/rawImg.height), rectData.x, rectData.y, rectData.w, rectData.h);
                    ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.strokeRect(rectData.x, rectData.y, rectData.w, rectData.h);
                }
            } else if (mode === 'poly' && polyPoints.length > 0) {
                ctx.save(); ctx.beginPath(); ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for(let i=1; i<polyPoints.length; i++) ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                if(polyPoints.length > 2) ctx.closePath(); ctx.clip(); ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height); ctx.restore();
                ctx.beginPath(); ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 2; ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for(let i=1; i<polyPoints.length; i++) ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                if(polyPoints.length > 2) ctx.lineTo(polyPoints[0].x, polyPoints[0].y); ctx.stroke();
                ctx.fillStyle = 'red'; polyPoints.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); });
            }
        }
        function initBgCropBox() {
            let screenRatio = window.innerWidth / window.innerHeight;
            let imgRatio = canvas.width / canvas.height;
            let w, h;
            if (imgRatio > screenRatio) { h = canvas.height * 0.9; w = h * screenRatio; } 
            else { w = canvas.width * 0.9; h = w / screenRatio; }
            rectData = { x: (canvas.width - w) / 2, y: (canvas.height - h) / 2, w: w, h: h };
        }
        function getPos(e) { let r = canvas.getBoundingClientRect(); let cx = e.touches?e.touches[0].clientX:e.clientX; let cy = e.touches?e.touches[0].clientY:e.clientY; return {x:cx-r.left, y:cy-r.top}; }
        function start(e) { if(e.type==='touchstart')e.preventDefault(); let p=getPos(e); if(mode==='rect'){isDragging=true;startPos=p; if(currentUploadType!=='bg') rectData={x:p.x,y:p.y,w:0,h:0}; else startBgDrag(p); }else{polyPoints.push(p);draw();} }
        let bgDragOffset = {x:0, y:0};
        function startBgDrag(p) { if (p.x >= rectData.x && p.x <= rectData.x + rectData.w && p.y >= rectData.y && p.y <= rectData.y + rectData.h) { bgDragOffset.x = p.x - rectData.x; bgDragOffset.y = p.y - rectData.y; } else { rectData.x = p.x - rectData.w/2; rectData.y = p.y - rectData.h/2; bgDragOffset.x = rectData.w/2; bgDragOffset.y = rectData.h/2; } }
        function move(e) { if(!isDragging||mode!=='rect')return; if(e.type==='touchmove')e.preventDefault(); let p=getPos(e); if (currentUploadType === 'bg') { rectData.x = p.x - bgDragOffset.x; rectData.y = p.y - bgDragOffset.y; } else { rectData.w=p.x-startPos.x; rectData.h=p.y-startPos.y; } draw(); }
        function end() { isDragging=false; }
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        function setMode(m) { mode=m; resetCrop(); draw(); }
        function resetCrop() { rectData={x:0,y:0,w:0,h:0}; polyPoints=[]; draw(); }

        const aquarium = document.getElementById('aquarium'); const fishes = [];
        function removeFishFromScreen(key) { const index = fishes.findIndex(f => f.dbKey === key); if(index !== -1) { if(fishes[index].container) fishes[index].container.remove(); fishes.splice(index, 1); } }
        class Fish {
            constructor(data, dbKey) {
                this.dbKey = dbKey; this.imageSrc = data.image; this.size = data.size || (Math.random() * 80 + 50); this.authorInfo = data.author ? `${data.fromClass} ${data.author}` : "";
                this.container = document.createElement('div'); this.container.className = 'fish-container'; this.container.style.opacity = '0';
                if(this.authorInfo) { this.container.classList.add('has-author'); let label = document.createElement('div'); label.className = 'fish-name-label'; label.innerText = this.authorInfo; this.container.appendChild(label); }
                this.element = document.createElement('img'); this.element.src = this.imageSrc; this.element.className = 'fish-img'; this.element.style.width = this.size + 'px';
                this.container.appendChild(this.element);
                let labelHeight = this.authorInfo ? 25 : 0; this.x = Math.random() * (window.innerWidth - this.size); this.y = Math.random() * (window.innerHeight - this.size - labelHeight) + labelHeight;
                this.vx = (Math.random() - 0.5) * 3; this.vy = (Math.random() - 0.5) * 1.5; if(Math.abs(this.vx) < 0.5) this.vx = 1;
                this.container.onclick = async (e) => {
                    e.stopPropagation(); 
                    if(isDeleteMode) { if(await customConfirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) firebase.database().ref('school_aquarium_fish/' + currentClassId + '/' + this.dbKey).remove(); return; }
                    if(isSubmitMode) {
                        let authorName = await customPrompt("è«‹è¼¸å…¥ä½œè€…å­¸ç”Ÿå§“åï¼š");
                        if(authorName) { firebase.database().ref('school_aquarium_fish/Lobby').push({ image: this.imageSrc, size: this.size, author: authorName, fromClass: currentClassId, timestamp: Date.now() }).then(async () => { await customAlert(`å·²ç™¼å¸ƒåˆ°å¤§å»³ï¼`); toggleSubmitMode(); }); }
                        return;
                    }
                    if(this.authorInfo) await customAlert("âœ¨ å„ªç§€ä½œå“ï¼š\n" + this.authorInfo);
                };
                aquarium.appendChild(this.container); setTimeout(() => { this.container.style.opacity = '1'; }, 100);
            }
            updateStyle() {
                this.container.classList.remove('deletable', 'submittable'); this.container.style.cursor = this.authorInfo ? 'help' : 'default';
                if(isDeleteMode) { this.container.classList.add('deletable'); this.container.style.cursor = 'pointer'; } 
                else if (isSubmitMode) { this.container.classList.add('submittable'); this.container.style.cursor = 'pointer'; }
            }
            update() {
                let labelOffset = this.authorInfo ? 25 : 0; this.x += this.vx; this.y += this.vy;
                if (this.x <= 0 || this.x + this.size >= window.innerWidth) this.vx *= -1;
                if (this.y <= labelOffset || this.y + this.size >= window.innerHeight) this.vy *= -1;
                this.container.style.transform = `translate(${this.x}px, ${this.y}px)`;
                let scaleX = this.vx > 0 ? -1 : 1; this.element.style.transform = `scaleX(${scaleX})`;
            }
        }
        function createFish(data, key) { const f = new Fish(data, key); f.updateStyle(); fishes.push(f); }
        function animate() { fishes.forEach(fish => fish.update()); requestAnimationFrame(animate); }
        animate();
    </script>
</body>
</html>
