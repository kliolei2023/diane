<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ ¡åœ’æ•¸ä½å…±å‰µæ°´æ—ç®± (åˆ†ç­ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #222; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* æ°´æ—ç®±å®¹å™¨ */
        #aquarium {
            width: 100%; height: 100%;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg,#4facfe 0%, #00f2fe 100%);
            background-size: cover;
            background-position: center;
            transition: background 0.5s ease;
        }

        /* èƒŒæ™¯åœ–ç‰‡å±¤ */
        #bg-image-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 0.5s;
            z-index: 0; pointer-events: none;
        }

        /* æµ·åº•æ²™åœ° */
        #sand {
            position: absolute; bottom: 0; width: 100%; height: 80px;
            background: #e6d99c; border-top: 5px solid #d4c585; 
            z-index: 2; pointer-events: none;
        }

        /* --- é ‚éƒ¨ç­ç´šåˆ— --- */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0,0,0,0.6); z-index: 150;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box; color: white;
        }
        #class-info { font-size: 18px; font-weight: bold; color: #ffeb3b; display: flex; align-items: center; gap: 10px;}
        #class-controls { display: flex; gap: 5px; }
        
        input.class-input {
            padding: 5px; border-radius: 4px; border: none; width: 80px; text-align: center;
        }

        /* --- å·¦å´æ“ä½œé¢æ¿ --- */
        #controls {
            position: absolute; top: 60px; left: 15px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }

        .panel {
            background: rgba(255,255,255,0.95); 
            padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 8px; width: 180px;
        }

        h3 { margin: 0 0 5px 0; font-size: 16px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        
        .btn {
            border: none; padding: 8px; border-radius: 6px; 
            font-size: 14px; cursor: pointer; color: white;
            text-align: center; font-weight: bold; transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: #007bff; }
        .btn-orange { background: #fd7e14; }
        .btn-red { background: #dc3545; }
        .btn-gray { background: #6c757d; }
        .btn-purple { background: #6f42c1; }

        /* åˆªé™¤æ¨¡å¼å•Ÿç”¨æ™‚çš„æŒ‰éˆ•ç‹€æ…‹ */
        .delete-mode-active {
            background: #dc3545 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        input[type="file"] { display: none; }

        /* é­šçš„æ¨£å¼ */
        .fish { 
            position: absolute; z-index: 10; 
            cursor: pointer; /* é è¨­æ˜¯æŒ‡æ¨™ */
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
            transition: opacity 0.5s, filter 0.2s; 
        }
        
        /* åˆªé™¤æ¨¡å¼ä¸‹çš„é­š */
        .fish.deletable:hover {
            filter: drop-shadow(0 0 10px red); /* è¢«é¸ä¸­æ™‚ç™¼ç´…å…‰ */
            transform: scale(1.1);
        }

        /* --- è£å‰ªè¦–çª— (Modal) --- */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column;
        }
        #toolbar {
            height: 70px; background: #333; display: flex; align-items: center; justify-content: center; gap: 10px;
            padding: 0 10px; color: white;
        }
        #canvas-wrapper {
            flex: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative; touch-action: none;
        }
        canvas { border: 2px solid #666; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .radio-group { display: flex; gap: 10px; background: #555; padding: 5px 15px; border-radius: 20px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 14px; color: white;}
        
        #loading-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 5; pointer-events: none;
        }

    </style>
</head>
<body>

    <div id="aquarium">
        <div id="top-bar">
            <div id="class-info">
                <span>ç­ç´šï¼š</span>
                <span id="current-class-display">å…¬å…±å¤§å»³</span>
            </div>
            <div id="class-controls">
                <input type="text" id="classInput" class="class-input" placeholder="è¼¸å…¥ç­è™Ÿ">
                <button class="btn btn-blue" style="padding: 5px 10px;" onclick="switchClass()">é€²å…¥/æ–°å¢</button>
            </div>
        </div>

        <div id="loading-msg">æ­£åœ¨é€£ç·šè‡³é›²ç«¯æ°´æ—ç®±...</div>
        <img id="bg-image-layer" src="" alt="Background">
        <div id="sand"></div>

        <div id="controls">
            <div class="panel">
                <h3>ğŸŸ å‰µä½œèˆ‡ä¸Šå‚³</h3>
                <button class="btn btn-blue" onclick="document.getElementById('fishInput').click()">ğŸ“¸ ä¸Šå‚³ä¸¦è£å‰ªç•«ä½œ</button>
                <input type="file" id="fishInput" accept="image/*" onchange="handleFishFile(this)">
            </div>

            <div class="panel">
                <h3>ğŸ› ï¸ ç®¡ç†å·¥å…·</h3>
                <button id="deleteModeBtn" class="btn btn-purple" onclick="toggleDeleteMode()">âŒ åˆªé™¤å–®éš»é­š (é—œ)</button>
                <div style="font-size:12px; color:#666; margin-bottom:5px;">é–‹å•Ÿå¾Œï¼Œé»æ“Šé­šå³å¯åˆªé™¤</div>
                
                <button class="btn btn-red" onclick="clearAllFish()">ğŸ—‘ï¸ ä¸€éµæ¸…ç©ºæœ¬ç­</button>
            </div>

            <div class="panel">
                <h3>ğŸ« å ´æ™¯è¨­å®š</h3>
                <button class="btn btn-orange" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸ æ›´æ›èƒŒæ™¯</button>
                <input type="file" id="bgInput" accept="image/*" onchange="handleBgFile(this)">
                <button class="btn btn-gray" onclick="resetBackground()">ğŸŒŠ æ¢å¾©æ·±æµ·</button>
            </div>
        </div>
    </div>

    <div id="modal">
        <div id="toolbar">
            <div class="radio-group">
                <label><input type="radio" name="mode" value="rect" checked onclick="setMode('rect')"> ğŸŸ¦ æ–¹å½¢</label>
                <label><input type="radio" name="mode" value="poly" onclick="setMode('poly')"> âœ‚ï¸ æé‚Š</label>
            </div>
            <button class="btn btn-green" id="finishBtn" onclick="finishCrop()">ä¸Šå‚³é›²ç«¯</button>
            <button class="btn btn-red" onclick="resetCrop()">é‡ç½®</button>
            <button class="btn btn-gray" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
        <div id="canvas-wrapper">
            <canvas id="editor"></canvas>
        </div>
        <div style="text-align:center; color:#aaa; padding:8px; font-size:14px;" id="instruction">æ‹–æ›³ç•«å‡ºæ–¹æ¡†</div>
    </div>

    <script>
        // ==========================================
        // Firebase è¨­å®š
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAUoYIt2CdivHIoLK-ZjsucejJkuzzQRnA",
            authDomain: "fish321-36ce2.firebaseapp.com",
            databaseURL: "https://fish321-36ce2-default-rtdb.firebaseio.com",
            projectId: "fish321-36ce2",
            storageBucket: "fish321-36ce2.firebasestorage.app",
            messagingSenderId: "237771099270",
            appId: "1:237771099270:web:9621037d8ec40242091507",
            measurementId: "G-4QESL7JL49"
        };

        let dbRef = null;
        let currentClassId = "Lobby"; // é è¨­ç­ç´š ID
        let isDeleteMode = false;     // åˆªé™¤æ¨¡å¼ç‹€æ…‹

        // åˆå§‹åŒ– Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            initClassRoom(currentClassId); // å•Ÿå‹•é è¨­ç­ç´š
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading-msg').innerText = "é€£ç·šå¤±æ•—";
        }

        // ==========================================
        //  ç­ç´šç®¡ç†æ ¸å¿ƒé‚è¼¯
        // ==========================================
        
        // åˆ‡æ›ç­ç´š
        function switchClass() {
            const inputVal = document.getElementById('classInput').value.trim();
            if(!inputVal) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±ï¼");
            
            // é¿å…ç‰¹æ®Šå­—å…ƒé€ æˆè·¯å¾‘éŒ¯èª¤
            const safeClassId = inputVal.replace(/[.#$/[\]]/g, "_"); 
            
            initClassRoom(safeClassId);
            document.getElementById('classInput').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        }

        // åˆå§‹åŒ–/é€£æ¥åˆ°æŒ‡å®šç­ç´š
        function initClassRoom(classId) {
            // 1. å¦‚æœä¹‹å‰æœ‰é€£ç·šï¼Œå…ˆæ–·é–‹èˆŠçš„ç›£è½
            if (dbRef) {
                dbRef.off(); 
            }

            // 2. æ¸…ç©ºç•«é¢ä¸Šçš„é­š
            const allFishes = document.querySelectorAll('.fish');
            allFishes.forEach(f => f.remove());
            fishes.length = 0; // æ¸…ç©ºé™£åˆ—

            // 3. æ›´æ–°ç‹€æ…‹
            currentClassId = classId;
            document.getElementById('current-class-display').innerText = classId === "Lobby" ? "å…¬å…±å¤§å»³" : classId + " ç­";
            document.getElementById('loading-msg').style.display = 'block';
            document.getElementById('loading-msg').innerText = `æ­£åœ¨è¼‰å…¥ ${classId} çš„æ°´æ—ç®±...`;

            // 4. é‡æ–°é€£æ¥è³‡æ–™åº«è·¯å¾‘ï¼š school_aquarium_fish / ç­ç´šID
            dbRef = firebase.database().ref('school_aquarium_fish/' + classId);

            // 5. ç›£è½ï¼šæ–°å¢é­š
            dbRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                const key = snapshot.key; // å–å¾—é€™éš»é­šçš„å”¯ä¸€ ID
                if(data && data.image) {
                    createFish(data.image, key); 
                }
                document.getElementById('loading-msg').style.display = 'none';
            });

            // 6. ç›£è½ï¼šåˆªé™¤é­š (ç•¶æœ‰äººåˆªé™¤æ™‚ï¼ŒåŒæ­¥ç§»é™¤ç•«é¢ä¸Šçš„é­š)
            dbRef.on('child_removed', (snapshot) => {
                const key = snapshot.key;
                removeFishFromScreen(key);
            });
        }

        // æ¸…ç©ºå…¨ç­åŠŸèƒ½
        function clearAllFish() {
            if(!dbRef) return;
            let confirmClear = confirm(`âš ï¸ è­¦å‘Šï¼\n\næ‚¨ç¢ºå®šè¦æ¸…ç©ºã€${currentClassId}ã€‘æ‰€æœ‰çš„é­šå—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`);
            if(confirmClear) {
                // ç›´æ¥ç§»é™¤è©²ç­ç´šç¯€é»ä¸‹çš„æ‰€æœ‰è³‡æ–™
                dbRef.remove()
                    .then(() => alert("æ°´æ—ç®±å·²æ¸…ç©ºï¼"))
                    .catch(err => alert("æ¸…ç©ºå¤±æ•—ï¼š" + err.message));
            }
        }

        // åˆªé™¤æ¨¡å¼åˆ‡æ›
        function toggleDeleteMode() {
            isDeleteMode = !isDeleteMode;
            const btn = document.getElementById('deleteModeBtn');
            const aquariumDiv = document.getElementById('aquarium');
            
            if(isDeleteMode) {
                btn.innerText = "âœ… çµæŸåˆªé™¤æ¨¡å¼";
                btn.classList.add('delete-mode-active');
                aquariumDiv.style.cursor = "crosshair"; // æ¸¸æ¨™è®Šæˆæº–å¿ƒ
                alert("é€²å…¥åˆªé™¤æ¨¡å¼ï¼\n\nç¾åœ¨é»æ“Šç•«é¢ä¸Šçš„é­šï¼Œè©²éš»é­šå°±æœƒè¢«æ°¸ä¹…åˆªé™¤ã€‚");
            } else {
                btn.innerText = "âŒ åˆªé™¤å–®éš»é­š (é—œ)";
                btn.classList.remove('delete-mode-active');
                aquariumDiv.style.cursor = "default";
            }
            
            // æ›´æ–°æ‰€æœ‰é­šçš„ç‹€æ…‹æ¨£å¼
            fishes.forEach(fish => fish.updateStyle());
        }

        // å¾ç•«é¢ç§»é™¤é­š (è¢«å‹•æ¥æ”¶è³‡æ–™åº«æŒ‡ä»¤)
        function removeFishFromScreen(key) {
            // å¾é™£åˆ—ä¸­æ‰¾åˆ°é€™éš»é­š
            const index = fishes.findIndex(f => f.dbKey === key);
            if(index !== -1) {
                // ç§»é™¤ DOM å…ƒç´ 
                if(fishes[index].element) fishes[index].element.remove();
                // å¾é™£åˆ—ç§»é™¤
                fishes.splice(index, 1);
            }
        }

        // ==========================================
        //  åœ–ç‰‡è™•ç†èˆ‡è®Šæ•¸
        // ==========================================
        let canvas = document.getElementById('editor');
        let ctx = canvas.getContext('2d');
        let rawImg = new Image();
        let mode = 'rect'; 
        let isDragging = false;
        let startPos = {x:0, y:0};
        let rectData = {x:0, y:0, w:0, h:0};
        let polyPoints = [];

        function handleBgFile(input) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    const bgLayer = document.getElementById('bg-image-layer');
                    bgLayer.src = e.target.result;
                    bgLayer.style.opacity = 1;
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        function resetBackground() { document.getElementById('bg-image-layer').style.opacity = 0; }

        function handleFishFile(input) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    rawImg.onload = function() { openModal(); }
                    rawImg.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        function openModal() { document.getElementById('modal').style.display = 'flex'; resetCrop(); resizeCanvas(); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        
        function resizeCanvas() {
            let wrapper = document.getElementById('canvas-wrapper');
            let scale = Math.min((wrapper.clientWidth-20)/rawImg.width, (wrapper.clientHeight-20)/rawImg.height);
            canvas.width = rawImg.width * scale; canvas.height = rawImg.height * scale;
            draw();
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (mode === 'rect' && rectData.w !== 0) {
                ctx.clearRect(rectData.x, rectData.y, rectData.w, rectData.h);
                ctx.drawImage(rawImg, rectData.x/(canvas.width/rawImg.width), rectData.y/(canvas.height/rawImg.height), rectData.w/(canvas.width/rawImg.width), rectData.h/(canvas.height/rawImg.height), rectData.x, rectData.y, rectData.w, rectData.h);
                ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2; ctx.strokeRect(rectData.x, rectData.y, rectData.w, rectData.h);
            } else if (mode === 'poly' && polyPoints.length > 0) {
                ctx.save(); ctx.beginPath(); ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for(let i=1; i<polyPoints.length; i++) ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                if(polyPoints.length > 2) ctx.closePath(); ctx.clip(); ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height); ctx.restore();
                ctx.beginPath(); ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 2; ctx.moveTo(polyPoints[0].x, polyPoints[0].y);
                for(let i=1; i<polyPoints.length; i++) ctx.lineTo(polyPoints[i].x, polyPoints[i].y);
                if(polyPoints.length > 2) ctx.lineTo(polyPoints[0].x, polyPoints[0].y); ctx.stroke();
                ctx.fillStyle = 'red'; polyPoints.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); });
            }
        }
        
        function getPos(e) { let r = canvas.getBoundingClientRect(); let cx = e.touches?e.touches[0].clientX:e.clientX; let cy = e.touches?e.touches[0].clientY:e.clientY; return {x:cx-r.left, y:cy-r.top}; }
        function start(e) { if(e.type==='touchstart')e.preventDefault(); let p=getPos(e); if(mode==='rect'){isDragging=true;startPos=p;rectData={x:p.x,y:p.y,w:0,h:0};}else{polyPoints.push(p);draw();} }
        function move(e) { if(!isDragging||mode!=='rect')return; if(e.type==='touchmove')e.preventDefault(); let p=getPos(e); rectData.w=p.x-startPos.x; rectData.h=p.y-startPos.y; draw(); }
        function end() { isDragging=false; }
        
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        function setMode(m) { mode=m; resetCrop(); document.getElementById('instruction').innerText = mode==='rect'?"æ‹–æ›³ç•«å‡ºæ–¹æ¡†":"æ²¿è‘—é­šé‚Šç·£é»æ“Š"; }
        function resetCrop() { rectData={x:0,y:0,w:0,h:0}; polyPoints=[]; draw(); }

        function finishCrop() {
            let tempCanvas = document.createElement('canvas'); let tCtx = tempCanvas.getContext('2d'); let r = rawImg.width/canvas.width;
            if(mode==='rect'){
                if(rectData.w===0) return alert("è«‹å…ˆæ¡†é¸");
                let fx=rectData.w>0?rectData.x:rectData.x+rectData.w, fy=rectData.h>0?rectData.y:rectData.y+rectData.h;
                tempCanvas.width=Math.abs(rectData.w)*r; tempCanvas.height=Math.abs(rectData.h)*r;
                tCtx.drawImage(rawImg, fx*r, fy*r, tempCanvas.width, tempCanvas.height, 0, 0, tempCanvas.width, tempCanvas.height);
            } else {
                if(polyPoints.length<3) return alert("è«‹è‡³å°‘é»3å€‹é»");
                let minX=Infinity, minY=Infinity, maxX=0, maxY=0; polyPoints.forEach(p=>{if(p.x<minX)minX=p.x;if(p.x>maxX)maxX=p.x;if(p.y<minY)minY=p.y;if(p.y>maxY)maxY=p.y;});
                tempCanvas.width=(maxX-minX)*r; tempCanvas.height=(maxY-minY)*r;
                tCtx.beginPath(); tCtx.moveTo((polyPoints[0].x-minX)*r, (polyPoints[0].y-minY)*r);
                for(let i=1; i<polyPoints.length; i++) tCtx.lineTo((polyPoints[i].x-minX)*r, (polyPoints[i].y-minY)*r);
                tCtx.closePath(); tCtx.clip(); tCtx.drawImage(rawImg, -minX*r, -minY*r, rawImg.width, rawImg.height);
            }
            
            let base64 = tempCanvas.toDataURL('image/png', 0.8);
            
            // ä¸Šå‚³åˆ°ç•¶å‰ç­ç´š
            if(dbRef) {
                document.getElementById('finishBtn').innerText = "ä¸Šå‚³ä¸­...";
                dbRef.push({ image: base64, timestamp: Date.now() })
                    .then(() => { closeModal(); document.getElementById('finishBtn').innerText = "ä¸Šå‚³é›²ç«¯"; })
                    .catch(err => { alert("ä¸Šå‚³å¤±æ•—"); document.getElementById('finishBtn').innerText = "ä¸Šå‚³é›²ç«¯"; });
            }
        }

        // ==========================================
        //  æ°´æ—ç®±èˆ‡é­š (æ”¯æ´åˆªé™¤åŠŸèƒ½)
        // ==========================================
        const aquarium = document.getElementById('aquarium');
        const fishes = [];

        class Fish {
            constructor(imgSrc, dbKey) {
                this.dbKey = dbKey; // å„²å­˜é€™éš»é­šåœ¨ Firebase çš„ ID
                this.element = document.createElement('img');
                this.element.src = imgSrc;
                this.element.className = 'fish';
                this.size = Math.random() * 80 + 50; 
                this.element.style.width = this.size + 'px';
                this.element.style.opacity = '0';
                
                this.x = Math.random() * (window.innerWidth - this.size);
                this.y = Math.random() * (window.innerHeight - this.size);
                this.vx = (Math.random() - 0.5) * 3;
                this.vy = (Math.random() - 0.5) * 1.5;
                if(Math.abs(this.vx) < 0.5) this.vx = 1;

                // ç¶å®šé»æ“Šåˆªé™¤äº‹ä»¶
                this.element.onclick = (e) => {
                    if(isDeleteMode) {
                        e.stopPropagation(); // é˜²æ­¢é»åˆ°å¾Œé¢
                        let confirmDel = confirm("ç¢ºå®šè¦åˆªé™¤é€™éš»é­šå—ï¼Ÿ");
                        if(confirmDel) {
                            // é€šçŸ¥ Firebase åˆªé™¤æ­¤ç¯€é»
                            firebase.database().ref('school_aquarium_fish/' + currentClassId + '/' + this.dbKey).remove();
                        }
                    }
                };

                aquarium.appendChild(this.element);
                setTimeout(() => { this.element.style.opacity = '1'; }, 100);
            }

            updateStyle() {
                if(isDeleteMode) {
                    this.element.classList.add('deletable');
                    this.element.style.cursor = 'pointer';
                } else {
                    this.element.classList.remove('deletable');
                    this.element.style.cursor = 'default';
                }
            }

            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x <= 0 || this.x + this.size >= window.innerWidth) this.vx *= -1;
                if (this.y <= 0 || this.y + this.size >= window.innerHeight) this.vy *= -1;
                let scaleX = this.vx > 0 ? -1 : 1;
                this.element.style.transform = `translate(${this.x}px, ${this.y}px) scaleX(${scaleX})`;
            }
        }

        function createFish(src, key) {
            const f = new Fish(src, key);
            f.updateStyle(); // æ ¹æ“šç•¶å‰æ˜¯å¦ç‚ºåˆªé™¤æ¨¡å¼è¨­å®šæ¨£å¼
            fishes.push(f);
        }

        function animate() {
            fishes.forEach(fish => fish.update());
            requestAnimationFrame(animate);
        }
        animate();

    </script>
</body>
</html>
